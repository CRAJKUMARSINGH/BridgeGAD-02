{% extends "base.html" %}

{% block title %}Bridge Preview{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-eye me-2"></i>
                        Bridge Drawing Preview
                    </h5>
                </div>
                <div class="card-body">
                    <!-- SVG Drawing Container -->
                    <div id="drawingContainer" class="text-center mb-4" style="background: white; border: 1px solid #ddd; border-radius: 5px; padding: 20px;">
                        <svg id="bridgeDrawing" width="800" height="400" viewBox="0 0 800 400" style="border: 1px solid #ccc;">
                            <!-- Drawing will be generated here -->
                        </svg>
                    </div>
                    
                    <!-- Download Options -->
                    <div class="row">
                        <div class="col-md-6">
                            <form method="POST" action="{{ url_for('generate_bridge') }}">
                                {% for key, value in parameters.items() %}
                                <input type="hidden" name="{{ key }}" value="{{ value }}">
                                {% endfor %}
                                <button type="submit" name="file_format" value="dxf" class="btn btn-primary btn-lg w-100">
                                    <i class="fas fa-cube me-2"></i>
                                    Download DXF
                                </button>
                            </form>
                        </div>
                        <div class="col-md-6">
                            <form method="POST" action="{{ url_for('generate_bridge') }}">
                                {% for key, value in parameters.items() %}
                                <input type="hidden" name="{{ key }}" value="{{ value }}">
                                {% endfor %}
                                <button type="submit" name="file_format" value="pdf" class="btn btn-warning btn-lg w-100">
                                    <i class="fas fa-file-pdf me-2"></i>
                                    Download PDF
                                </button>
                            </form>
                        </div>
                    </div>
                    
                    <div class="row mt-3">
                        <div class="col-12">
                            <a href="{{ url_for('index') }}" class="btn btn-secondary">
                                <i class="fas fa-arrow-left me-2"></i>
                                Back to Parameters
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Bridge drawing data passed from Flask
const bridgeData = {{ bridge_data | safe }};

// Generate SVG drawing
function drawBridge(data) {
    const svg = document.getElementById('bridgeDrawing');
    const svgNS = "http://www.w3.org/2000/svg";
    
    // Clear existing content
    svg.innerHTML = '';
    
    // Calculate scale to fit in SVG
    const margin = 40;
    const availableWidth = 800 - 2 * margin;
    const availableHeight = 400 - 2 * margin;
    
    const bridgeWidth = data.lbridge / 1000; // Convert mm to m for display
    const bridgeHeight = (data.toprl - data.sofl) / 1000;
    
    const scaleX = availableWidth / bridgeWidth;
    const scaleY = availableHeight / bridgeHeight;
    const scale = Math.min(scaleX, scaleY, 50); // Max scale for readability
    
    // Center the drawing
    const offsetX = margin + (availableWidth - bridgeWidth * scale) / 2;
    const offsetY = margin + (availableHeight - bridgeHeight * scale) / 2;
    
    // Transform coordinates
    function transformX(x) {
        return offsetX + (x / 1000) * scale;
    }
    
    function transformY(y) {
        const baseY = data.sofl - 5000;
        return offsetY + availableHeight - ((y - baseY) / 1000) * scale;
    }
    
    // Draw main bridge deck
    const deckLine = document.createElementNS(svgNS, 'line');
    deckLine.setAttribute('x1', transformX(data.left));
    deckLine.setAttribute('y1', transformY(data.toprl));
    deckLine.setAttribute('x2', transformX(data.left + data.lbridge));
    deckLine.setAttribute('y2', transformY(data.toprl));
    deckLine.setAttribute('stroke', 'black');
    deckLine.setAttribute('stroke-width', '2');
    svg.appendChild(deckLine);
    
    // Draw soffit
    const soffitLine = document.createElementNS(svgNS, 'line');
    soffitLine.setAttribute('x1', transformX(data.left));
    soffitLine.setAttribute('y1', transformY(data.sofl));
    soffitLine.setAttribute('x2', transformX(data.left + data.lbridge));
    soffitLine.setAttribute('y2', transformY(data.sofl));
    soffitLine.setAttribute('stroke', 'black');
    soffitLine.setAttribute('stroke-width', '2');
    svg.appendChild(soffitLine);
    
    // Draw left abutment
    const leftAbt = document.createElementNS(svgNS, 'rect');
    leftAbt.setAttribute('x', transformX(data.left));
    leftAbt.setAttribute('y', transformY(data.toprl));
    leftAbt.setAttribute('width', (data.abtlen / 1000) * scale);
    leftAbt.setAttribute('height', transformY(data.alfl) - transformY(data.toprl));
    leftAbt.setAttribute('fill', 'none');
    leftAbt.setAttribute('stroke', 'black');
    leftAbt.setAttribute('stroke-width', '1');
    svg.appendChild(leftAbt);
    
    // Draw right abutment
    const rightAbt = document.createElementNS(svgNS, 'rect');
    rightAbt.setAttribute('x', transformX(data.left + data.lbridge - data.abtlen));
    rightAbt.setAttribute('y', transformY(data.toprl));
    rightAbt.setAttribute('width', (data.abtlen / 1000) * scale);
    rightAbt.setAttribute('height', transformY(data.arfl) - transformY(data.toprl));
    rightAbt.setAttribute('fill', 'none');
    rightAbt.setAttribute('stroke', 'black');
    rightAbt.setAttribute('stroke-width', '1');
    svg.appendChild(rightAbt);
    
    // Draw piers if multi-span
    if (data.nspan > 1) {
        const spanLength = data.lbridge / data.nspan;
        for (let i = 1; i < data.nspan; i++) {
            const pierX = data.left + (i * spanLength);
            const pier = document.createElementNS(svgNS, 'rect');
            pier.setAttribute('x', transformX(pierX - data.piertw/2));
            pier.setAttribute('y', transformY(data.capt));
            pier.setAttribute('width', (data.piertw / 1000) * scale);
            pier.setAttribute('height', transformY(data.futrl) - transformY(data.capt));
            pier.setAttribute('fill', 'none');
            pier.setAttribute('stroke', 'black');
            pier.setAttribute('stroke-width', '1');
            svg.appendChild(pier);
        }
    }
    
    // Add title
    const title = document.createElementNS(svgNS, 'text');
    title.setAttribute('x', 400);
    title.setAttribute('y', 30);
    title.setAttribute('text-anchor', 'middle');
    title.setAttribute('font-family', 'Arial, sans-serif');
    title.setAttribute('font-size', '16');
    title.setAttribute('font-weight', 'bold');
    title.textContent = 'SLAB BRIDGE ELEVATION';
    svg.appendChild(title);
    
    // Add scale
    const scaleText = document.createElementNS(svgNS, 'text');
    scaleText.setAttribute('x', 50);
    scaleText.setAttribute('y', 380);
    scaleText.setAttribute('font-family', 'Arial, sans-serif');
    scaleText.setAttribute('font-size', '12');
    scaleText.textContent = `SCALE 1:${Math.round(1000/scale)}`;
    svg.appendChild(scaleText);
}

// Draw the bridge when page loads
document.addEventListener('DOMContentLoaded', function() {
    drawBridge(bridgeData);
});
</script>
{% endblock %}