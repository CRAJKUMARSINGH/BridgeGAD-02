{% extends "base.html" %}

{% block title %}Bridge Preview{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-eye me-2"></i>
                        Bridge Drawing Preview
                    </h5>
                </div>
                <div class="card-body">
                    <!-- SVG Drawing Container -->
                    <div id="drawingContainer" class="text-center mb-4" style="background: white; border: 1px solid #ddd; border-radius: 5px; padding: 20px;">
                        <svg id="bridgeDrawing" width="800" height="400" viewBox="0 0 800 400" style="border: 1px solid #ccc;">
                            <!-- Drawing will be generated here -->
                        </svg>
                    </div>
                    
                    <!-- Download Options -->
                    <div class="row">
                        <div class="col-md-6">
                            <form method="POST" action="{{ url_for('generate_bridge') }}">
                                {% for key, value in parameters.items() %}
                                <input type="hidden" name="{{ key }}" value="{{ value }}">
                                {% endfor %}
                                <button type="submit" name="file_format" value="dxf" class="btn btn-primary btn-lg w-100">
                                    <i class="fas fa-cube me-2"></i>
                                    Download DXF
                                </button>
                            </form>
                        </div>
                        <div class="col-md-6">
                            <form method="POST" action="{{ url_for('generate_bridge') }}">
                                {% for key, value in parameters.items() %}
                                <input type="hidden" name="{{ key }}" value="{{ value }}">
                                {% endfor %}
                                <button type="submit" name="file_format" value="pdf" class="btn btn-warning btn-lg w-100">
                                    <i class="fas fa-file-pdf me-2"></i>
                                    Download PDF
                                </button>
                            </form>
                        </div>
                    </div>
                    
                    <div class="row mt-3">
                        <div class="col-12">
                            <a href="{{ url_for('index') }}" class="btn btn-secondary">
                                <i class="fas fa-arrow-left me-2"></i>
                                Back to Parameters
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Bridge drawing data and drawing elements from server
const bridgeData = {{ bridge_data | safe }};

// Generate SVG preview using server-generated drawing data
function drawBridge(data) {
    const svg = document.getElementById('bridgeDrawing');
    const svgNS = "http://www.w3.org/2000/svg";
    
    // Clear existing content
    svg.innerHTML = '';
    
    // Request drawing data from server
    fetch('/get-drawing-data', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(drawingData => {
        renderDrawingElements(drawingData);
    })
    .catch(error => {
        console.error('Error fetching drawing data:', error);
        // Fallback to simple drawing
        drawSimpleBridge(data);
    });
}


function drawSimpleBridge(data) {
    // Fallback simple bridge drawing
    const svg = document.getElementById('bridgeDrawing');
    const svgNS = "http://www.w3.org/2000/svg";
    
    svg.innerHTML = '';
    
    // Set white background
    const background = document.createElementNS(svgNS, 'rect');
    background.setAttribute('width', '800');
    background.setAttribute('height', '400');
    background.setAttribute('fill', 'white');
    svg.appendChild(background);
    
    const margin = 40;
    const bridgeWidth = data.LBRIDGE || 30000;
    const scale = (800 - 2 * margin) / bridgeWidth * 1000;
    
    function transformX(x) {
        return margin + x * scale / 1000;
    }
    
    function transformY(y) {
        return 200 + (110000 - y) * scale / 5000;
    }
    
    // Draw deck line
    const deck = document.createElementNS(svgNS, 'line');
    deck.setAttribute('x1', transformX(data.LEFT || 0));
    deck.setAttribute('y1', transformY(data.TOPRL || 110000));
    deck.setAttribute('x2', transformX((data.LEFT || 0) + bridgeWidth));
    deck.setAttribute('y2', transformY(data.TOPRL || 110000));
    deck.setAttribute('stroke', 'black');
    deck.setAttribute('stroke-width', '3');
    svg.appendChild(deck);
    
    // Draw soffit line  
    const soffit = document.createElementNS(svgNS, 'line');
    soffit.setAttribute('x1', transformX(data.LEFT || 0));
    soffit.setAttribute('y1', transformY(data.SOFL || 108000));
    soffit.setAttribute('x2', transformX((data.LEFT || 0) + bridgeWidth));
    soffit.setAttribute('y2', transformY(data.SOFL || 108000));
    soffit.setAttribute('stroke', 'black');
    soffit.setAttribute('stroke-width', '2');
    svg.appendChild(soffit);
    
    // Add title
    const title = document.createElementNS(svgNS, 'text');
    title.setAttribute('x', 400);
    title.setAttribute('y', 30);
    title.setAttribute('text-anchor', 'middle');
    title.setAttribute('font-family', 'Arial, sans-serif');
    title.setAttribute('font-size', '16');
    title.setAttribute('font-weight', 'bold');
    title.setAttribute('fill', 'black');
    title.textContent = 'SLAB BRIDGE ELEVATION';
    svg.appendChild(title);
}

// Draw the bridge when page loads
document.addEventListener('DOMContentLoaded', function() {
    drawBridge(bridgeData);
});
</script>
{% endblock %}